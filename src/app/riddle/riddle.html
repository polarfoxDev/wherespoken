<div class="riddle">
  <div class="card">
    <!-- Header -->
    <div class="card-header">
      <h2>Guess the Language</h2>
      <p>Listen carefully and identify the language spoken.</p>
    </div>

    <div class="card-body">
      <!-- Stage 0: Audio -->
      <div class="section">
        <label class="section-label">Audio Sample</label>
        <audio controls [src]="sample().audioUrl"></audio>
      </div>

      <!-- Stage 1: Text -->
      @if (stage() >= 1) {
      <div class="section animate-in">
        <label class="section-label">Transcript</label>
        <div class="transcript" [innerHTML]="highlightedText()"></div>
      </div>
      }

      <!-- Stage 2: Translation -->
      @if (stage() >= 2) {
      <div class="section animate-in">
        <label class="section-label">Translation</label>
        <div class="translation">"{{ sample().englishTranslation }}"</div>
      </div>
      }

      <!-- Stage 3: Audio Hint -->
      @if (stage() >= 3) {
      <div class="section animate-in">
        <label class="section-label">Audio Hint</label>
        <audio controls [src]="sample().audioHintUrl"></audio>
      </div>
      }

      <!-- Stage 4: Text Hint -->
      @if (stage() >= 4) {
      <div class="section animate-in">
        <label class="section-label">Hint</label>
        <p class="hint-text">{{ sample().hint }}</p>
      </div>
      }

      <!-- Stage 5: Hint Translation -->
      @if (stage() >= 5 && sample().hintEnglishTranslation) {
      <div class="section animate-in">
        <label class="section-label">Hint Translation</label>
        <p class="translation">{{ sample().hintEnglishTranslation }}</p>
      </div>
      }

      <!-- Feedback Message -->
      @if (feedbackMessage()) {
      <div
        class="feedback animate-in"
        [class.error]="feedbackMessage()?.type === 'error'"
        [class.warning]="feedbackMessage()?.type === 'warning'"
      >
        <span class="feedback-icon">
          @if(feedbackMessage()?.type === 'error') { üö´ }
          @if(feedbackMessage()?.type === 'warning') { ‚ö†Ô∏è }
        </span>
        <span>{{ feedbackMessage()?.text }}</span>
      </div>
      }

      <!-- Guess Input Section -->
      <div class="guess-section">
        @if (gameStatus() === 'WON') {
        <div class="result-box won animate-in">
          <div class="result-icon">üéâ</div>
          <h3>Correct!</h3>
          <p>
            You correctly identified <span class="language">{{ displayLanguage() }}</span>!
          </p>
          <div class="emoji-history">
            @for (emoji of historyEmojis(); track $index) {
            <span>{{ emoji }}</span>
            }
          </div>
        </div>
        } @else if (gameStatus() === 'LOST') {
        <div class="result-box lost animate-in">
          <div class="result-icon">üò¢</div>
          <h3>Game Over</h3>
          <p>
            The correct language was <span class="language">{{ displayLanguage() }}</span>.
          </p>
          <div class="emoji-history">
            @for (emoji of historyEmojis(); track $index) {
            <span>{{ emoji }}</span>
            }
          </div>
        </div>
        } @else {
        <div>
          <label class="guess-label">Type your guess</label>
          <div class="guess-row">
            <div class="guess-input-wrapper">
              <input
                type="text"
                class="guess-input"
                [formControl]="guessControl"
                (focus)="showDropdownHandler()"
                (blur)="hideDropdownHandler()"
                (keydown.enter)="submitGuess()"
                placeholder="e.g. French, Japanese..."
              />

              @if (showDropdown() && filteredLanguages().length > 0) {
              <ul class="dropdown">
                @for (option of filteredLanguages(); track option.code) {
                <li (mousedown)="selectLanguage(option)">
                  {{ option.label }}
                  <span class="code">{{ option.code }}</span>
                </li>
                }
              </ul>
              }
            </div>
            <button class="submit-button" (click)="submitGuess()">Guess</button>
          </div>

          <div class="hints-row">
            <span class="hints-count">
              @if(stage() > 0) { Hints revealed: {{ stage() }}/5 }
            </span>

            @if (stage() < 5) {
            <span class="hints-warning">Wrong guess reveals the next hint</span>
            }
          </div>
        </div>
        }
      </div>
    </div>
  </div>
</div>
