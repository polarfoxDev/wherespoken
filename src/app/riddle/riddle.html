<div class="max-w-xl mx-auto p-4 pb-20">
  <!-- Difficulty Toggle -->
  <div class="flex justify-end mb-3">
    <button
      class="flex items-center gap-2 py-2 px-4 rounded-xl text-sm font-medium transition-all border-2"
      [class]="
        gameStarted()
          ? 'opacity-50 cursor-not-allowed bg-black/5 border-black/10 text-text/60 dark:bg-white/5 dark:border-white/10 dark:text-text-inverse/60'
          : difficulty() === 'normal'
            ? 'bg-success/10 border-success/30 text-success dark:text-success-bright'
            : difficulty() === 'hard'
              ? 'bg-warn/10 border-warn/30 text-warn dark:text-warn-bright'
              : 'bg-accent/10 border-accent/30 text-accent dark:text-accent-bright'
      "
      (click)="toggleDifficulty()"
      [disabled]="gameStarted()"
      [attr.aria-label]="
        gameStarted()
          ? 'Difficulty locked: ' + difficultyLabel()
          : 'Difficulty: ' + difficultyLabel() + '. ' + difficultyDescription()
      "
    >
      <span>{{ difficultyLabel() }}</span>
      @if (gameStarted()) {
        <span class="text-xs opacity-70">ðŸ”’ Locked</span>
      } @else {
        <span class="text-xs opacity-70">{{ difficultyDescription() }}</span>
      }
    </button>
  </div>

  <div
    class="animate-in rounded-2xl shadow-lg border border-black/5 dark:border-white/10 bg-white dark:bg-white/5"
  >
    <div class="p-6 flex flex-col gap-5">
      <div class="text-center text-text/70 dark:text-text-inverse/70">
        ðŸŽ§ Listen and identify both the language spoken and the country of the speaker. The content
        does not contain any intentional clues about the language or country.
      </div>

      <!-- Stage 0: Audio -->
      <div class="p-4 rounded-xl bg-black/3 dark:bg-white/5">
        <label
          class="block text-xs font-bold uppercase tracking-widest mb-3 text-guess dark:text-guess-bright"
          >Audio Sample</label
        >
        <audio controls [src]="sample().audioUrl" class="w-full rounded-lg"></audio>
      </div>

      <!-- Guess Input Section -->
      <div class="border-t border-black/10 dark:border-white/10 pt-5 mt-2">
        @if (gameStatus() === 'WON') {
          <div
            class="animate-in py-8 px-6 rounded-2xl text-center bg-success/10 text-success dark:text-success-bright"
          >
            <div class="text-5xl mb-4">ðŸŽ‰</div>
            <h3 class="m-0 mb-2 text-2xl font-bold">Correct!</h3>
            <p class="m-0 text-base">
              You correctly identified <span class="font-bold">{{ displayLanguage() }}</span
              >!
            </p>
            <div class="flex flex-col items-center gap-1 mt-4 text-base">
              @for (emoji of historyEmojis(); track $index) {
                <div>{{ emoji }}</div>
              }
            </div>
            <div class="flex gap-3 justify-center mt-5">
              <button
                class="py-2 px-4 rounded-xl bg-success text-text-inverse font-medium transition-all hover:scale-105"
                (click)="copy()"
              >
                {{ copyConfirmation() ? 'âœ“ Copied!' : 'ðŸ“‹ Copy' }}
              </button>
              @if (canShare) {
                <button
                  class="py-2 px-4 rounded-xl bg-success text-text-inverse font-medium transition-all hover:scale-105"
                  (click)="share()"
                >
                  ðŸ“¤ Share
                </button>
              }
            </div>
          </div>
        } @else if (gameStatus() === 'LOST') {
          <div
            class="animate-in py-8 px-6 rounded-2xl text-center bg-warn/10 text-warn dark:text-warn-bright"
          >
            <div class="text-5xl mb-4">ðŸ˜¢</div>
            <h3 class="m-0 mb-2 text-2xl font-bold">Game Over</h3>
            <p class="m-0 text-base">
              The correct language was <span class="font-bold">{{ displayLanguage() }}</span
              >.
            </p>
            <div class="flex flex-col items-center gap-1 mt-4 text-base">
              @for (emoji of historyEmojis(); track $index) {
                <div>{{ emoji }}</div>
              }
            </div>
            <div class="flex gap-3 justify-center mt-5">
              <button
                class="py-2 px-4 rounded-xl bg-warn text-text-inverse font-medium transition-all hover:scale-105"
                (click)="copy()"
              >
                {{ copyConfirmation() ? 'âœ“ Copied!' : 'ðŸ“‹ Copy' }}
              </button>
              @if (canShare) {
                <button
                  class="py-2 px-4 rounded-xl bg-warn text-text-inverse font-medium transition-all hover:scale-105"
                  (click)="share()"
                >
                  ðŸ“¤ Share
                </button>
              }
            </div>
          </div>
        } @else {
          <div>
            <label class="block text-sm font-medium mb-3">Type your guess</label>
            <div class="flex gap-3 relative">
              <div class="flex-1 relative">
                <input
                  type="text"
                  class="w-full py-3.5 px-4 text-base rounded-xl outline-none transition-all box-border border-2 border-black/10 dark:border-white/20 bg-white dark:bg-white/10 focus:border-solution"
                  [formControl]="guessControl"
                  (focus)="showDropdownHandler()"
                  (blur)="hideDropdownHandler()"
                  (input)="showDropdownHandler()"
                  (keydown.enter)="submitGuess()"
                  placeholder="e.g. French, Japanese..."
                />

                @if (showDropdown() && filteredLanguages().length > 0) {
                  <ul
                    class="absolute z-50 left-0 right-0 mt-2 rounded-xl shadow-2xl max-h-60 overflow-y-auto list-none py-2 m-0 bg-white dark:bg-surface-dark border border-black/10 dark:border-white/10"
                  >
                    @for (option of filteredLanguages(); track option.code) {
                      <li
                        class="px-4 py-3 cursor-pointer text-base transition-colors hover:bg-solution/10"
                        (mousedown)="$event.preventDefault(); selectLanguage(option)"
                      >
                        {{ option.label }}
                        <span class="text-xs ml-2 font-mono opacity-60">{{ option.code }}</span>
                      </li>
                    }
                  </ul>
                }
              </div>
              <button
                class="py-3.5 px-6 text-base font-semibold rounded-xl cursor-pointer transition-all whitespace-nowrap bg-solution hover:bg-solution-bright text-text-inverse"
                (click)="submitGuess()"
              >
                Guess
              </button>
            </div>

            <div class="flex justify-between items-center mt-3 text-sm">
              <span class="text-text/60 dark:text-text-inverse/60">
                @if (history().length > 0) {
                  Guesses: {{ history().length }}/6
                  @if (showHints() && visibleHintsCount() < totalAvailableHints()) {
                    Â· Hints: {{ visibleHintsCount() }}/{{ totalAvailableHints() }}
                  }
                } @else if (!showHints()) {
                  {{ difficultyLabel() }} mode
                }
              </span>

              @if (showHints() && visibleHintsCount() < totalAvailableHints()) {
                <span class="font-medium text-accent dark:text-accent-bright">
                  @if (difficulty() === 'hard') {
                    More hints available later
                  } @else {
                    Wrong guess reveals the next hint
                  }
                </span>
              }
            </div>
          </div>
        }
      </div>

      <!-- Feedback Message -->
      @if (feedbackMessage()) {
        <div
          class="animate-in flex flex-col gap-2 p-4 rounded-xl text-sm font-medium bg-warn/10 text-warn dark:text-warn-bright"
        >
          <div class="flex items-center gap-3">
            <span class="text-xl"> ðŸš« </span>
            <span>{{ feedbackMessage()?.text }}</span>
          </div>
          @if (showAncestry() && feedbackMessage()?.familyComparison; as fc) {
            <app-ancestry
              [familyComparisonResult]="fc"
              [difficulty]="difficulty()"
              [guessLabel]="guessLabel()"
            ></app-ancestry>
          }
        </div>
      }
      @if (showHints() && stage() >= 1) {
        <h2 class="block font-medium mb-3">Hints:</h2>
      }

      <!-- Stage 5: Hint Translation -->
      @if (showHintTranslation() && sample().hintEnglishTranslation) {
        <div class="animate-in p-4 rounded-xl bg-black/3 dark:bg-white/5">
          <label
            class="block text-xs font-bold uppercase tracking-widest mb-3 text-guess dark:text-guess-bright"
            >Hint Transcript Translation</label
          >
          <p dir="auto" class="p-4 rounded-xl m-0 bg-accent/10 text-accent dark:text-accent-bright">
            "{{ sample().hintEnglishTranslation }}"
          </p>
        </div>
      }

      <!-- Stage 4: Text Hint -->
      @if (showHintText()) {
        <div class="animate-in p-4 rounded-xl bg-black/3 dark:bg-white/5">
          <label
            class="block text-xs font-bold uppercase tracking-widest mb-3 text-guess dark:text-guess-bright"
            >Hint Transcript</label
          >
          <p
            dir="auto"
            class="transcript-text p-5 rounded-xl border-l-4 border-solution bg-white dark:bg-white/5 leading-relaxed"
          >
            {{ sample().hint }}
          </p>
        </div>
      }

      <!-- Stage 3: Audio Hint -->
      @if (showHintAudio()) {
        <div class="animate-in p-4 rounded-xl bg-black/3 dark:bg-white/5">
          <label
            class="block text-xs font-bold uppercase tracking-widest mb-3 text-guess dark:text-guess-bright"
            >Hint (includes information about the country)</label
          >
          <audio controls [src]="sample().audioHintUrl" class="w-full rounded-lg"></audio>
        </div>
      }

      <!-- Transcript -->
      @if (showTranscript()) {
        <div class="animate-in p-4 rounded-xl bg-black/3 dark:bg-white/5">
          <label
            class="block text-xs font-bold uppercase tracking-widest mb-3 text-guess dark:text-guess-bright"
            >Transcript</label
          >
          <div
            dir="auto"
            class="transcript-text p-5 rounded-xl border-l-4 border-solution bg-white dark:bg-white/5 text-lg leading-relaxed"
            [innerHTML]="highlightedText()"
          ></div>
        </div>
      }

      <!-- Transcript Translation -->
      @if (showTranscriptTranslation()) {
        <div class="animate-in p-4 rounded-xl bg-black/3 dark:bg-white/5">
          <label
            class="block text-xs font-bold uppercase tracking-widest mb-3 text-guess dark:text-guess-bright"
            >English Translation of Transcript</label
          >
          <div
            dir="auto"
            class="p-4 rounded-xl m-0 bg-accent/10 text-accent dark:text-accent-bright"
          >
            "{{ sample().englishTranslation }}"
          </div>
        </div>
      }
    </div>
  </div>
</div>
